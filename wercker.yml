box:
  id: cmwn/front-node:6-wheezy
build:
  steps:
    - script:
      name: Install packages
      code: npm prune && npm install && tar cf $WERCKER_CACHE_DIR/nm_cache.tar node_modules
    - script:
      name: more dumb 1
      code: npm update
    - script:
      name: +1 dump step of dumbness with keen
      code: npm rebuild node-sass
    - script:
      name: more dumb 2
      code: npm rebuild imagemin-optipng
    - script:
      name: Linter
      code: gulp lint
    - script:
      name: Unit Tests
      code: gulp unit
    - script:
      name: Build packages
      code: gulp build --production
  after-steps:
    - slack-notifier:
      url: $SLACK_URL

release:
  box: python:2.7
  steps:
    - script:
      name: Preparing release
      code: |-
        export VERSION="$($PWD/bin/version_bump.sh --print-current)"
        echo "$VERSION"
        mkdir -p artifact
        mv build.zip artifact/platform-front-$VERSION.zip
        ls -al artifact/platform-front-$VERSION.zip
        echo "Changed file name"
    - s3sync:
      name: Uploading package to Amazon S3
      key-id: $AWS_ACCESS_KEY_ID
      key-secret: $AWS_SECRET_ACCESS_KEY
      bucket-url: $AWS_BUCKET_URL
      source-dir: artifact/
      delete-removed: false
    - github-create-release:
      name: Creating release on github
      token: $MC_GITHUB_TOKEN
      tag: $VERSION
      draft: false
    - github-upload-asset:
      name: Adding build artifact to tag
      token: $MC_GITHUB_TOKEN
      tag: $VERSION
      file: artifact/platform-front-$VERSION.zip
      filename: platform-front-$VERSION.zip

draft-release:
  box: python:2.7
  steps:
    - script:
      name: Preparing release
      code: |-
        export SHORT_HASH=$(git log -n 1 --abbrev-commit | head -n 1 | sed -e 's/^commit //')
        export VERSION="$($PWD/bin/version_bump.sh --print-current)-$SHORT_HASH"
        echo "$VERSION"
        mkdir -p artifact
        mv build.zip artifact/platform-front-$VERSION.zip
        ls -al artifact/platform-front-$VERSION.zip
        echo "Changed file name"
    - s3sync:
      name: Uploading package to Amazon S3
      key-id: $AWS_ACCESS_KEY_ID
      key-secret: $AWS_SECRET_ACCESS_KEY
      bucket-url: $AWS_BUCKET_URL
      source-dir: artifact/
      delete-removed: false
    - github-create-release:
      name: Creating release on github
      token: $MC_GITHUB_TOKEN
      tag: $VERSION
      draft: true
    - github-upload-asset:
      name: Adding build artifact to tag
      token: $MC_GITHUB_TOKEN
      tag: $VERSION
      file: artifact/platform-front-$VERSION.zip
      filename: platform-front-$VERSION.zip

deploy-draft:
  box: python:2.7
  steps:
    - script:
      name: Preparing release
      code: |-
        export SHORT_HASH=$(git log -n 1 --abbrev-commit | head -n 1 | sed -e 's/^commit //')
        export VERSION="$($PWD/bin/version_bump.sh --print-current)-$SHORT_HASH"
        echo "$VERSION"
    - script:
      name: Installing pips
      code: |-
        pip install boto3
        export DEPLOY='true'
    - script:
      name: Running deploy
      code: |-
        echo "Deploying $DEPLOY_APP_NAME @ $VERSION to $DEPLOY_ENV"
        python bin/deploy.py $VERSION $DEPLOY_APP_NAME $DEPLOY_ENV -v
  after-steps:
    - slack-notifier:
      url: $SLACK_URL

deploy:
  box: python:2.7
  steps:
    - script:
      name: Preparing release
      code: |-
        export VERSION="$($PWD/bin/version_bump.sh --print-current)"
        echo "$VERSION"
    - script:
      name: Installing pips
      code: |-
        pip install boto3
        export DEPLOY='true'
    - script:
      name: Running deploy
      code: |-
        echo "Deploying $DEPLOY_APP_NAME @ $VERSION to $DEPLOY_ENV"
        python bin/deploy.py $VERSION $DEPLOY_APP_NAME $DEPLOY_ENV -v
  after-steps:
    - slack-notifier:
      url: $SLACK_URL
