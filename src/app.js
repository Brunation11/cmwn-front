/**
 * App.js
 * # Production Application Entrypoint
..............................................................................................................
..............................................................................................................
.........................................................................,....................................
..,,,,,,,,,,,,,,,,,,,,,,,...............................................,,,...................................
:::~~~~:777.,:,,,,,==~~~~~::::,,,...............................,..,,,,,,,,,,,,,.,............................
II?+I,,,,,,,,,,,,,,,,:,,,::::++=~~::,,,......................,,.,,.,,,,,,,,,,,,,,,.,..........................
,,,,,,,,,,,,,,,,,,,,,,:,::::::::::::+=~~:,,,..............,,,,,,,,,,,,,,,,,,,,,,,,,,,,,.,.....................
:~II=:::,:,,,,:,,::::::::::,:,:~=+:::::::+=~:,,..........,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,.....................
,,,,,,,,,,,,,,:::::::::::::::::::~::::::::~::+=~:,,....,.,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,.,..................
,,,,,,,,,,,,,,,,,,::,::::~~:7:=~:~::::~=~:~:::~~+=~:,,,,,,,,,,,,,,,,,,,,,:,,,,,,,,,,,,,,,,,,..................
,,,,,,,,,,,,,,,~:,,,,,:::,,::~:,::~~::::~::~~=~~??~+=~:,,,,,,,,,,,,,,,,,::,,,,,,,,,,,,,,,,,,,,................
,,,,,,,,,,,,,::::~,,,,,,,,,,,,,::=~:::::::::~~+~~~~~~=+=~:,,,,,,,,,,,,,,::,,,,,,,,,,,,,,,,,,,,................
,,,,,,,,,,,,,,,:,,,,,,,,,,,,,,~:~:~::=:::::::~==~=~~:~=~?=~:,,,,,,,,:,::::::,,,,,,,,,,,,,,,,,,,,,.,...........
,,,,,,,,:::::,,,,:::~,,,,,,:,,,:~:,,~:::~?:~==~~==~~~=~=~==+~::,,::::::::~::::::::,,,,,,,,,,,,,,,,............
,,,,,,,:,,,,~,,,,,::::~:,,,:=:~:~::~:~:~::~~==~+~=~=+=~++~==++=~::::::::~~:::::::::,,,,,,,,,,,,,.,............
.,,,,,,,,,,,,,,,,,::::~,,~::,~~::~~:~~=:,~~+~~~=~====+==++~+=+++=~:::::~~~~:::::::::,,,:::,,,,,,,,,...........
,......,..,.,,,.,,,,,,~,~~~~:,:::~~~:~,:=+,,:~=~:===~=+++=++++??7+=~:~~~==~~~~~:::::::::,,,,,,,,,,,,..........
..,..........,,,,,,:,:::,~=~::~~~,~,~:=:,:=:~::+=~===~=+=+++++?I7?7?====++==~~~~:~~~::,,,,,,,,,,,,,...........
................,,,:::,~,::::~~:,:~,:,:~::=~====~==~~+=+=++++++I?I7I7?++?I++==~~=~~:::::,,,,,,,,,,,...........
...................,,,:,::::,:::,,:~?::,,,,:~~++===~~==++==~?+???I777777I7??+?+=~~:::::,,,,,,,,,,,,,..........
....................,:,,,,:,::::,,::~~~:,,~:::~:=~=~+=~=+==~=??+II7II77777 7I?+=~~::::::,,,,,,,,,,,,,.........
....................,,.:::,,,,,::~:,,:,:~,,,::~~~~~~=+=+==+~~===++?777777777??==~~~::::,,,,,,,,,,,,...........
.......,,,,,,,,,,.,,,,,:::::,,,:,,,,,,,::=:~,,=,:=~~~===~=?~====++??I7777777I?+=~~::::::,,,,,,,,,,............
......,,,,,,,:,:.,:,:,,:,.,:.,,,,,,,,,,,,:~~=~:,:::~:~=~~=~?~~==I??II7777777I++=~~:::::,,,,,,,,,,,,...........
.......,..,,,,.,:,:,,:,:::..,,,,,,,,,,,,,,,,,~~~=,::=~+~+:~=~~~II777777777I77+~~=~~::::,,,,,,,,,,,.,..........
.......,,,,,::,,:..,::,........,,,,,,~,,,,,,,,,,:::::=~~+::~??+I+I7I7777I77+7I=~~:~~:::,,,,,,,,,,.,...........
.....,,,,,,.,,,::,::,:.....~:...,,,,,,:,,,,,,,,,,~:::::~~?=~~~=+?7?IIIII77I7+7?=::::::::,,,,,,,,,,,...........
....,,,,,,,::,.,:,:,::,..........,,,,,,,,,,,,,,::+:::::==++~:~~?????I7+7777?777+~:::,,,::,,,,,,,,,.,..........
.....,,,,,,,,,,::,,,,,...........,,,,,,,,,,,,,~~:,,::::::~,:::~~?~~====I7777I7I7=~::,,,,,,,,,,,,,.............
.....,.,,,,,,,,:,,,...............,,::::~~.,,,,,,,,:::::::::~:~~~~~~~I==I7777I?I?=:,,,,,,,,,,,,,,.............
..........,,.,..........::,:::,:~~:~:~~~~==,,,,,,,,,:::::::::::~~~~~~~~~I7I7II777?~:,,,,,,,,,,,,,,............
...........,.........,,:,,::::~~~~,::~~=~==,,,,,,,,,,,,::::::::::~~~~~~~=IIIII7+77+~,,,,,,,,,,,,..............
..........,.,,,,:,,,,,,,:::::::~~~~~=~~~==,,,,,,,,,,,,,:::::::::::~~~~~~~I77777777I=:,,,,,,,,,................
.........,,,,,,::,::::::::::::~~~~~~========.,,,,,,,,,,,,:,+?IIII:::::++II7IIIII7:7?~,,,,,,,..................
........,,,,,,,:,:::::::::::::~~~~~~~~===========+==,,,,,,:???IIIIIIIIIII7II?IIII7::=:,,,,....................
....,,,,,,,.,,,:,::,,,,:::::::::~~~~~~~~~~======~=+++++?,,,????IIIIIIII7II?II77III77:~,,......................
...,,,,,,,,,,,,,,,::::::::::::~::~~~~~~~===========++=+??????IIIIIIIIIII7II::I7II7I77+:,......................
..,,,,,,,,,,,:,,,,,::::::::::::::~~~~~~~~~~~========+++++??????III?IIIIII7I?::???7I777~,......................
.,.,,.,,,,,,,,,,,,::::::::::::::::~~~~~~~~==~=======+=++?+???????I??IIIIII7I?:~I?IIIII=:,.....................
.,,,,,,,,,,,,,,,,,,::::::::::::::::~~~~~~~~~~~=~====+++++++?????????IIIIIIII??::IIIII77~,.....................
.,.,,,,,,,,,,,,,:,::::::::::::::::::~~~~~~~~~~~~=~====++=~=+???????+?III?IIIII+::?7II7I=:.....................
.,,,,,,,,,,,,,,,,::::::::::::,:::::~::~~~~~~~~~~====+=++++=???????++???III?IIIII::++III+:,....................
.,,,,,,,,,,,,,,,,,,::::::::::::::::~::~:~:~~~~~~=~~===~+++=+?????????=?+IIII??I?+:I++III~,....................
,,,,,,,,,,,,,,,,,,,:::::::::::::::::,,:,:::::~~~~~=======+++???+?????????II?I??7?,::+III=:....................
.,,,,,,,,,,,,,,,,,,::::::,::::::::,::::::::~~~:~=========++++~~+?+????+??IIIII??I?::++II=:,...................
,,,,,,,,,,,,,,,,,,,::::::::::::::::::,~~~:~~:~::~~====~=+++++~++?=??+?+??I??IIII??I::II?:~,...................
,,,,,,,,,,,,,,,,,,,::::::::,,,,,::::::::::~~~~~~=~~=====+++++=~=+=+?????????II?IIIII:,7I:~,...................
,,,,,,,,,,,,,,,,,,,,:::::::,:,:::::,:,~::::~~~~~~~~=~=~=+=+~+~~=+=++?++????????+?I??~:+?:=,...................
,,,,,,,,,,,,,,,,,,,,,,,:,:,:,::::::::,::::::~~~~~=~:~~===+~~~==++++==+?????????I????~~:I:=:...................
.,,,,,,,,,,,,,,,,,,,,,,,,,::::::::::::::::~:~~~~~~~:=~=====~~~==+++?++????+???+??+?==7I:,=:,..................
,.,.,.,,,,,,,,,,,,,,,:,,,::::::::::::::::::::~~~~~~~~====~=+=~~==+++++??????????+=+~~?=:I::,..................
.....,,,,,,,,,,,,,,,,,,,,,:,:::,::::::::::::::~~~~~~~==~~===+==+=++++~+????????+++==~=?I?::,..................
....,,,.,,,,,,,,,,,,,,,,,:,:,,,,::::::::::::::~~~~~~~=~=====+==+++++++????+=??=??==~+~+?+:~,..................
 * ## Structure of this file:
 * This file contains the bare minimum components to bootstrap the application: the react application wrapper
 * component, the router, and the redux process for a single page load. There are also some additional helper
 * sections that load polyfills and other utilities.
 *
 * ## Structure of this application
 * From here, there are three primary code folders: templates, routes, and components
 * Templates are simply page wrappers that provide structure and style. Headers, footers and sidebars are
 * configured here
 * Routes contain the actual pages which will be loaded by the router. The folder structure of routes should
 * exactly match the intended route url, dynamic route segments nonwithstanding (/schools/my-school/profile
 * will be located in /routes/schools/profile.js). Each route component must export exactly one route object.
 * The top tag in each route component should be a template. If a page requires custom styles, these should be
 * in a matching .scss file in the same folder (/routes/schools/profile.scss in our prior example). In this
 * case, the page's template should have a unique classname applied to it, and this classname should wrap all
 * styles to isolate them from other pages. Each route must expect to load one primary API endpoint for its
 * initial load (see route definitions section)
 * Components are reusable, generic components that are employed throughout pages. They may or may not provide
 * their own data, but regardless should always prefer to intake data through a `data` react prop. For example
 * `<myComponent data={some.custom.data} />`. Many components expect their children to accept a data property.
 * Components with custom styles should follow the same rules for class isolation as routes.
 *
 * ## Route Definitions
 * Routes are defined in the root of the application in public_routes.js and private_routes.js. These files
 * currently load all route components and attach page titles and bind API endpoints to themselves. Each
 * route expects a single api endpoint to provide the page with initial data. This happens automatically
 * on each transition. Further dependent data that needs to be loaded must expose itselve via the bound
 * endpoint's HAL _links section.
 *
 * ## Page Lifecycle
 * Our pages' data is exposed via a Redux store. What this means is that all data is immutable, and page state
 * can only be updated using the Store.dispatch method. Generally, this is handled for you. Each page load
 * consists of several distinct steps, which are dependent on the prior step:
 * 1) Transition: clear prior data, if there is any. Update the current url parameters (state.location)
 * 2) Authorization: Bound to the "/" api endpoint, which either provides the HAL links available to an
 * unauthenticated user, or provides the current user and the HAL links that make up their global actions
 * (left menu, logout, forgot password, etc)
 * 3) Page Data: Each route must have an API endpoint bound to it. This endpoint is now loaded.
 * 4) Component Data: Pages may register components that also require data. Such endpoints must be returned
 * by the Page Data step as HAL links. All component data is loaded simultaneously here.
 *
 * ## Important Components
 * The following components handle the generic data flow through the app and their purpose may not be as
 * immediately obvious as components representing UI elements or utility functions. The following components
 * handle nearly all data processing and async requests for the entire app. If you are unsure about where a
 * particular page behavior is originating, it is extremely likely it is in one of the following files:
 * ### action_constants.js
 * a flat list of all Redux actions the application is consuming. If adding actions,
 * they must always be added here before being attached to behavior in actions.js or consumed in store.js
 * ### store.js
 * contains all Redux reducers. A reducer takes data provided by an action that has been dispatched
 * and integrates it into the application state. The store then issues an update event to all pages and
 * components. All application data is processed in this file, and all Redux data middleware is applied here.
 * ### actions.js
 * binds action constants to behavior. All auth, page, and component HTTP requests are issued
 * from this file, as well as any other actions that have multiple dependent stages or that operate async.
 * ### datasource.js
 * higher-order (factory) component that binds keys to HAL links, and registers components
 * with the application.
 */

import 'polyfills';//minor polyfills here. Major polyfilles (e.g. es5 shim) loaded in index from cdn

import React from 'react';
import { Provider, connect } from 'react-redux';
import _ from 'lodash';
import ReactDOM from 'react-dom';
import { Router } from 'react-router';

import GlobalHeader from 'components/global_header';
import Log from 'components/log';
import History from 'components/history';
import GLOBALS from 'components/globals';
import PublicRoutes from 'public_routes';
import PrivateRoutes from 'private_routes';
import Store from 'components/store';
import Util from 'components/util';
import DevTools from 'components/devtools';
import Actions from 'components/actions';
import GlobalAlert from 'components/global_alert';
import Detector from 'components/browser_detector';
import Errors from 'components/errors';
import Home from 'routes/home';

//import 'reset.css';
import 'overrides.scss';
//import 'app.scss';

import 'media/logo.png';

const BROWSER_NOT_SUPPORTED = 'For the best viewing experience we recommend the desktop version in Chrome.<br />If you don\'t have chrome, <a href="https://www.google.com/chrome/browser/desktop/index.html" target="_blank">download it for free here</a>.';

//htaccess should take care of it but if somehow it does not, this should overkill the issue
if (window.location.protocol !== 'https:') {
    window.location.href = 'https:' + window.location.href.substring(window.location.protocol.length);
}

document.domain = 'changemyworldnow.com';

var renderDevTool = () => {
    if (_.isFunction(DevTools) && (~GLOBALS.MODE.indexOf('local') || ~GLOBALS.MODE.indexOf('dev'))) {
        return <DevTools />;
    }
    return null;
};

//this section disables right clicking on images to dissuade downloading.
var oncontextmenu = document.oncontextmenu;
var onmousedown = document.onmousedown;
document.oncontextmenu = function (e) {
    if (e.target.nodeName === 'IMG') {
        return false;
    }
    if (_.isFunction(oncontextmenu)) {
        oncontextmenu(...arguments);
    }
};
//document.captureEvents = document.captureEvents || _.noop;
//document.captureEvents(Event.MOUSEDOWN);
document.onmousedown = function (e) {
    if (e.target.nodeName === 'IMG') {
        return false;
    }
    if (_.isFunction(onmousedown)) {
        onmousedown(...arguments);
    }
};

//█▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀█
//█  1. Top Level React Components
//█▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄█

var AppComponent = React.createClass({
    getInitialState: function () {
        return {
            logoLink: '/'
        };
    },
    componentWillMount: function () {
        Errors.onError(this.globalUpdate);
    },
    componentDidMount: function () {
        if (this.props.currentUser != null) {
            this.setState({logoLink: this.props.currentUser.user_id ? '/profile' : '/'});
        }
    },
    componentWillReceiveProps: function (nextProps) {
        if (nextProps.currentUser != null) {
            this.setState({logoLink: nextProps.currentUser.user_id ? '/profile' : '/'});
        }
    },
    isHome: function () {
        return window.location.href.toLowerCase().indexOf('home') !== -1 ||
               window.location.pathname === '/' ||
               window.location.pathname === '';
    },
    globalUpdate: function () {
        this.forceUpdate();
    },
    globalAlert: function () {
        if (!window.navigator.standalone && (Detector.isIe9() || Detector.isIe10())) {
            GlobalAlert({text: BROWSER_NOT_SUPPORTED, type: 'warning', animate: 'scroll-left'});
        }
    },
    render: function () {
        if (this.isHome()) {
            return (
                <div>
                    {this.globalAlert()}
                    <Home />
                    {renderDevTool()}
                </div>
            );
        }
        return (
            <div>
                {this.globalAlert()}
                {Errors.renderErrors()}
                <GlobalHeader logoLink={this.state.logoLink} currentUser={this.props.currentUser} />
                <div className="sweater">
                    {this.props.children}
                </div>
                {renderDevTool()}
            </div>
        );
    }
});

const mapStateToProps = state => {
    var currentUser = {};
    if (state.currentUser != null) {
        currentUser = state.currentUser;
    }
    return {
        currentUser
    };
};

var App = connect(mapStateToProps)(AppComponent);

/** Default route. Currently does nothing except display a 404, as this loading indicates no route found**/
var Landing = React.createClass({
    render: function () {
        Errors.show404();
        return (
            <div> </div>
        );
    }
});

/** List of all routes. As-is, routes cannot be loaded dynamically at runtime, and must be registered here first **/
var routes = {
    path: '/',
    component: App,
    indexRoute: {component: Landing},
    childRoutes: PublicRoutes.concat(PrivateRoutes).concat([
        { path: '*', component: Landing},
    ]),
};


//█▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀█
//█  2. Page Lifecycle Definition
//█▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄█

var progressivePageLoad = function () {
    var pageRoute;
    var state = Store.getState();
    if (state.pageLoadingStage.currentStage !== state.pageLoadingStage.lastCompletedStage || state.pageLoadingStage.currentStage >= GLOBALS.PAGE_LOAD_STATE.FINAL) {
        return;
    }
    switch (state.pageLoadingStage.currentStage) {
    case GLOBALS.PAGE_LOAD_STATE.INITIALIZE: //Fresh Reload. Reset Everything
        Store.dispatch({
            type: 'combo',
            types: ['LOADER_START', 'LOADER_SUCCESS', 'LOADER_ERROR'],
            sequence: true,
            payload: [
                Actions.PAGE_LOADING,
                Actions.AUTHORIZE_APP
            ]
        });
        break;
    case GLOBALS.PAGE_LOAD_STATE.BOOTSTRAPPED:
        Store.dispatch({
            type: 'combo',
            types: ['LOADER_START', 'LOADER_SUCCESS', 'LOADER_ERROR'],
            sequence: true,
            payload: [
                Actions.FINISH_BOOTSTRAP,
                Actions.ADVANCE_LOAD_STAGE //Note: Finish bootstrap is not async, so loader complete must be called manually
            ]
        });
        break;
    case GLOBALS.PAGE_LOAD_STATE.PAGE: //We are authorized. Store the current user and proceed to page load
        if (state.location.endpoint && state.location.endpoint.indexOf('$') === 0) {
            //Looking for the string $$ at the beginning of a route to indicate
            //that it should be pulled directly from the users context
            if (state.currentUser._links[state.location.endpoint.slice(2)] != null) {
                if (state.currentUser._links[state.location.endpoint.slice(2)].templated) {
                    pageRoute = Util.modifyTemplatedQueryParams(
                        Store.getState().currentUser._links[state.location.endpoint.slice(2)].href,
                        {page: state.page.pageNum, per_page: state.page.itemCount} //eslint-disable-line camelcase
                    );
                } else {
                    pageRoute = Store.getState().currentUser._links[state.location.endpoint.slice(2)].href;
                }
            } else {
                Log.error('Route could not be loaded, route endpoint not provided for the current user');
            }
        } else {
            pageRoute = GLOBALS.API_URL + Util.replacePathPlaceholdersFromParamObject(
                state.location.endpoint == null ? '' : state.location.endpoint,
                Util.matchPathAndExtractParams(state.location.path, state.location.pathname)
            );
        }
        Store.dispatch({
            type: 'combo',
            types: ['LOADER_START', 'LOADER_SUCCESS', 'LOADER_ERROR'],
            sequence: true,
            payload: [
                Actions.PAGE_DATA.bind(null, pageRoute, state.location.title),
            ]
        });
        break;
    //components load after page, and are invoked through on the page, via a Datasource component calling Util.attemptGetComponentData
    //additional cases should be added here. Be sure to update the globals file with new states. They must be sequential, and
    //should always occur on every page load, so as not to block one another.
    //Make sure final is always last, naturally
    case GLOBALS.PAGE_LOAD_STATE.FINAL:
        break;
    }
};

//█▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀█
//█  3. Events occurring on transition. Note: DO NOT ISSUE SIDE EFFECTS. Dispatch actions via the store.
//█▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄█

History.listen(location => {
    var pathContext = _.find(routes.childRoutes, i => Util.matchPathAndExtractParams(i.path, location.pathname) !== false);
    if (pathContext == null && location.pathname !== '/') {
        //at this point we already know whether or not our path 404d...
        Errors.show404();
        return;
    }

    if (pathContext == null || pathContext.onEnter != null) {
        return; //don't bother operating on redirects
    }

    var nextLoc = _.defaults({}, location, pathContext);
    Actions.dispatch.RESET_LOADER(); //This very much needs to run sync at this exact moment.
    nextLoc.component = null; //no need to store this in state.
    Store.dispatch({
        type: 'combo',
        types: ['PAGE_CHANGE_START', 'PAGE_CHANGE_SUCCESS', 'PAGE_CHANGE_ERROR'],
        sequence: true,
        payload: [
            Actions.PATH_CHANGE.bind(null, {location: nextLoc})
        ]
    });
});

//█▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀█
//█  4. App Level Store Subscription. Note: Runs **VERY** frequently, so be careful what you add here.
//█▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄█

var lastState = {page: {}};
Store.subscribe(() => {
    //Note: This function, and all store subscribes, will be invoked once per second
    //at a minimum, and immediately after any action is dispatched. For this reason,
    //code here should be kept to an absolute minimum, and care should be taken not
    //to invoke more than one dispatch per call, as this will result in stack overflow
    //as this recurs as a result.
    var state = Store.getState();
    if (state.page && state.page.title !== lastState.page.title) {
        Util.setPageTitle(state.page.title);
    }
    progressivePageLoad();
    lastState = Store.getState();
});

//█▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀█
//█  5. Error Tracker and Logging Initialzation
//█▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄█

/** We need to generate a hash of the errors being generated to prevent them from firing too frequently**/
//from http://stackoverflow.com/questions/7616461/generate-a-hash-from-string-in-javascript-jquery
var hashCode = function (s){
  return s.split("").reduce(function(a,b){a=((a<<5)-a)+b.charCodeAt(0);return a&a},0); //eslint-disable-line
};

//Only report errors in production
if (window.Rollbar && ~window.__cmwn.MODE.indexOf('prod')){ //eslint-disable-line no-undef
    Rollbar.configure({reportLevel: 'error'}); //eslint-disable-line no-undef
}
//Dynamic rollbar configuration for throttling. Static configuration happens in index.php
//User configuration happens in Authorization.js (soon will be moved to actions.js)
if (window.Rollbar != null) { //eslint-disable-line no-undef
    //Quick and dirty leading edge throttle on rapid fire events
    Rollbar.configure({checkIgnore: function (isUncaught, args, payload) { //eslint-disable-line
        var key = hashCode((args[1] && args[1].toString()) || (args[2] && args[2].toString()) || args.join(' '));
        window.__cmwn._loggerevents = window.__cmwn._loggerevents || {};
        if (window.__cmwn._loggerevents[key] == null) {
            window.__cmwn._loggerevents[key] = Date.now();
            return false;
        } else if (window.__cmwn._loggerevents[key] - Date.now() > 60000) {
            window.__cmwn._loggerevents[key] = Date.now();
            return false;
        }
        return true;
    }});
}

/** Function enabling an interactive debugging mode via the console **/
window.__cmwn.interactiveDebug = function () {
    window.debugging = true;
    Rollbar.configure({reportLevel: 'info'}); //eslint-disable-line
};


//█▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀█
//█  6. Application Bootstrap
//█▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄█

/**
 * Attaches the App component to the routes, which are then attached to the Router, which is then attached
 * to the redux store via the Provider. This Provider is then rendered in the React shadow dom, and then is
 * appended to the the actual dom node with ID cmwn-app as soon as it is available.
 * Also outputs the console warning if this is successful, and will attempt to re-bootstrap up to 5 times
 * if any of these steps fail. A generic application error is shown if this fails.
 **/
function run() {
    window._bootstrap_attempts = window._bootstrap_attempts || 0; //eslint-disable-line camelcase
    try {
        window._bootstrap_attempts++;
        ReactDOM.render((
                <Provider store={Store} >
                    <Router history={History} routes={routes} />
                </Provider>
        ), document.getElementById('cmwn-app'));
        console.log('%cWoah there, World Changer!', 'font-weight: bold; color: red; font-size: 60px; font-family: Helvetica, Impact, Arial, sans-serif; text-shadow: 2px 2px grey;'); //eslint-disable-line no-console
        console.log('%cChangeMyWorldNow will never ask you to enter any of your information in this space, or ask you to paste anything here. For your security, we recommend you close this console.', 'font-weight: bold; color: #2CC4F4; font-size: 25px; font-family: Helvetica, Impact, Arial, sans-serif;'); //eslint-disable-line no-console
        if (GLOBALS.MODE.toLowerCase() === 'prod' || GLOBALS.MODE.toLowerCase() === 'production') {
            console.info = _.noop; //eslint-disable-line no-console
            console.log = _.noop; //eslint-disable-line no-console
            console.warn = _.noop; //eslint-disable-line no-console
            /**let errors surface*/
        }
        Log.info('Application started');
    } catch(err) {
        Log.info('Application bootstrap failed, attempting to recover. Attempt ' + window._bootstrap_attempts + ' out of 5');
        if (window._bootstrap_attempts < 5) {
            window.setTimeout(run, 500);
        } else {
            Errors.showApplication(err);
        }
    }
}

const loadedStates = ['complete', 'loaded', 'interactive'];

if (loadedStates.indexOf(document.readyState) !== -1 && document.getElementById('cmwn-app')) {
    run();
    console.info('running'); //eslint-disable-line
} else {
    window.addEventListener('DOMContentLoaded', run, false);
}

// We only need to export this for testing purposes. It is never imported in production.
export default App;

